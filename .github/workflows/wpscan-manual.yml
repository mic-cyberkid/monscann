name: Manual WPScan with Brute-Force

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target WordPress URL (e.g., https://example.com)'
        required: true
        type: string
      extra_flags:
        description: 'Additional WPScan flags (e.g., --stealthy --enumerate vp,vt,u)'
        required: false
        type: string
        default: '--enumerate vp,vt,u'  # Vulnerable plugins/themes + users
      output_format:
        description: 'Output format'
        required: false
        type: choice
        options: [cli, json]
        default: 'cli'
      enable_bruteforce:
        description: 'Enable password brute-force attack?'
        required: false
        type: boolean
        default: false
      wordlist_url:
        description: 'Custom password wordlist URL (direct .txt link). Default: 10k common passwords (fast).'
        required: false
        type: string
        default: 'https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/10k-most-common.txt'
      brute_force_flags:
        description: 'Extra brute-force flags (e.g., --threads 10 --usernames admin,user2)'
        required: false
        type: string
        default: '--threads 10'  # Safe multi-threading

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Pull latest WPScan Docker image
        run: docker pull wpscanteam/wpscan:latest

      - name: Download password wordlist (if brute-force enabled)
        if: inputs.enable_bruteforce == true
        run: |
          curl -L -o /tmp/passwords.txt "${{ inputs.wordlist_url }}"
          echo "Wordlist downloaded: $(wc -l < /tmp/passwords.txt) passwords"

      - name: Run WPScan
        env:
          WPSCAN_API_TOKEN: ${{ secrets.WPSCAN_API_TOKEN }}  # Free token recommended for full vuln DB
        run: |
          CMD="docker run --rm -v /tmp:/tmp wpscanteam/wpscan:latest \
            --url '${{ inputs.target_url }}' \
            --api-token '$WPSCAN_API_TOKEN' \
            ${{ inputs.extra_flags }} \
            --format ${{ inputs.output_format }} \
            --output /tmp/wpscan-report.${{ inputs.output_format == 'json' && 'json' || 'txt' }} \
            --no-banner"

          if [ "${{ inputs.enable_bruteforce }}" = "true" ]; then
            CMD="$CMD --passwords /tmp/passwords.txt ${{ inputs.brute_force_flags }}"
          fi

          echo "Running WPScan command:"
          echo "$CMD"
          eval $CMD

      - name: Upload Scan Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wpscan-report
          path: /tmp/wpscan-report.*
