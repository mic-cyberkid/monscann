name: Manual WPScan (Ruby Gem Installation) with Brute-Force

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target WordPress URL (e.g., https://example.com)'
        required: true
        type: string
      extra_flags:
        description: 'Additional WPScan flags (e.g., --stealthy --enumerate vp,vt,u)'
        required: false
        type: string
        default: '--enumerate vp,vt,u'  # Vulnerable plugins, vulnerable themes, users
      output_format:
        description: 'Output format'
        required: false
        type: choice
        options: [cli, json]
        default: 'cli'
      enable_bruteforce:
        description: 'Enable password brute-force attack?'
        required: false
        type: boolean
        default: false
      wordlist_url:
        description: 'Password wordlist URL (direct .txt link). Default: 10k most common (fast & safe).'
        required: false
        type: string
        default: 'https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/10k-most-common.txt'
      brute_force_flags:
        description: 'Extra brute-force flags (e.g., --usernames admin --max-password-tries 100 --password-attack xmlrpc)'
        required: false
        type: string
        default: ''

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (optional, for custom wordlists if needed)
        uses: actions/checkout@v4

      - name: Install Ruby and required dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby-full build-essential libcurl4-openssl-dev libxml2 libxml2-dev libxslt1-dev ruby-dev

      - name: Install WPScan Ruby gem
        run: sudo gem install wpscan

      - name: Update WPScan database
        run: sudo wpscan --update

      - name: Download password wordlist (only if brute-force enabled)
        if: inputs.enable_bruteforce == true
        run: |
          curl -L -o /tmp/passwords.txt "${{ inputs.wordlist_url }}"
          echo "Wordlist downloaded: $(wc -l < /tmp/passwords.txt) passwords"

      - name: Run WPScan
        env:
          WPSCAN_API_TOKEN: ${{ secrets.WPSCAN_API_TOKEN }}  # Add your free token in repo secrets for full vuln details
        run: |
          # Base command
          CMD="wpscan --url '${{ inputs.target_url }}' \
            ${{ inputs.extra_flags }} \
            --format ${{ inputs.output_format }} \
            --no-banner"

          # Add output file (saved for artifact upload)
          CMD="$CMD --output /tmp/wpscan-report.${{ inputs.output_format == 'json' && 'json' || 'txt' }}"

          # Add API token only if provided
          if [ -n "$WPSCAN_API_TOKEN" ]; then
            CMD="$CMD --api-token '$WPSCAN_API_TOKEN'"
          fi

          # Add brute-force options only if enabled
          if [ "${{ inputs.enable_bruteforce }}" = "true" ]; then
            CMD="$CMD --passwords /tmp/passwords.txt ${{ inputs.brute_force_flags }}"
          fi

          # Show and execute the command
          echo "Running WPScan command:"
          echo "$CMD"
          eval $CMD

      - name: Upload Scan Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wpscan-report-gem
          path: /tmp/wpscan-report.*
